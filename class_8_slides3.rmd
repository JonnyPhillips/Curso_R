---
title: "Analysis, Visualization and Mapping in R"
output:
  ioslides_presentation:
    incremental: no
    widescreen: yes
  beamer_presentation:
subtitle: Aula 8 - Mapeando Dados II
css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
library(tidyverse)
library(knitr)
library(sf)
library(cepespR)
library(dismo)
library(sp)
```

```{r, cache=T}
shapefile <- read_sf("Brazil_s.shp") %>% 
  separate(CD_GEOCODM,into=c("State","Mun"),sep=2, remove=FALSE) %>% 
  filter(State==26 & !(CD_GEOCODM %in% c(2605459,2607604))) %>% 
  mutate(COD_MUN_IBGE=as.numeric(CD_GEOCODM))

data <- cepespdata(year=2014, 
                   position="Governor",
                   regional_aggregation="Municipality",
                   political_aggregation="Candidate",
                   state="PE")

data <- data %>%
  group_by(COD_MUN_IBGE) %>%
  mutate(Vote_Pct=(QTDE_VOTOS/sum(QTDE_VOTOS))*100) %>%
  ungroup() %>%
  filter(NOME_URNA_CANDIDATO=="PAULO CÂMARA")

merged <- shapefile %>% left_join(data,by="COD_MUN_IBGE")

addresses <- c("Prefeitura, Recife, Brazil",
               "Museu da Cidade do Recife, Recife, Brazil",
               "Caruara, Pernambuco, Brazil",
               "Prefeitura, Salgueiro, Pernambuco, Brazil")
df <- dismo::geocode(addresses)
sf_points <- df %>% st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
```

## Aula 8 Objetivos
- Joins espaciais
- Calculando uma medida de clustering: Moran's I
- Trabalhando com rasters
- Novas visualizações

## Joins espaciais

- Os joins normais usam colunas e valores iguais nas duas tabelas para juntar
- Com dados espaciais, podemos juntar por localização
- Os CRSs precisam ser iguais

```{r}
merged %>% ggplot() + 
  geom_sf() +
  geom_sf(data=sf_points,col="red",size=4) +
  theme_classic() +
  coord_sf(datum=NA)
```

## Joins espaciais

```{r, echo=T}
merged <- merged %>% st_transform(4326)
intersects <- sf_points %>% st_join(merged,st_intersects)
```

```{r}
intersects %>% dplyr::select(OBJECTID,NM_MUNICIP,Shape_Area,COD_MUN_IBGE)
```

## Joins espaciais
- Contagem do número de pontos em cada polígono

```{r, echo=T,eval=F}
intersects %>% group_by(NOME_MUNICIPIO) %>% count()
```

```{r}
intersects %>% group_by(NOME_MUNICIPIO) %>% count() %>% st_set_geometry(NULL) %>% kable()
```

## Outras operações espaciais
- Distâncias entre pontos

```{r, echo=T}
sf_points %>% st_distance()
```

## Outras operações espaciais {.smaller}
- 'Buffer' pontos para polígonos
    - verifique uma projeção em metros

```{r, echo=T}
sf_points %>% st_transform(22524) %>% 
  st_buffer(10000) %>% 
  ggplot() + 
  geom_sf() + 
  theme_classic() + 
  coord_sf(datum=NA)
```

## Outras operações espaciais
- Pontos para polígonos com voronoi polígonos

```{r, echo=T}
library(dismo)
sf_voronoi <- merged %>% st_centroid() %>% 
  as("Spatial") %>% 
  voronoi() %>% 
  st_as_sf() %>% 
  st_intersection(st_union(shapefile %>% st_transform(4326)))
```

## Outras operações espaciais

```{r}
merged %>% st_centroid() %>% 
  ggplot() + 
  geom_sf() + 
  theme_classic() +
  coord_sf(datum=NA)
```

## Outras operações espaciais

```{r}
sf_voronoi %>% ggplot() + 
  geom_sf() + 
  theme_classic() +
  coord_sf(datum=NA)
```


## Calculando clustering: Moran's I {.smaller}

- Uma estatística de clustering
    
1 - Tirar ilhas (sem vizinhos)

```{r, echo=T}
library(spdep)
neighbours1 <- merged %>% as("Spatial") %>% poly2nb(queen=TRUE)
merged_contig <- merged %>% filter(card(neighbours1)!=0)
```

```{r}
summary(neighbours1)
```

## Calculando clustering: Moran's I {.smaller}

- Uma estatística de clustering

2 - Identificar vizinhos para cada feature

```{r, echo=T}
neighbours2 <- merged_contig %>% as("Spatial") %>% poly2nb(queen=TRUE)
```

```{r}
summary(neighbours2)
```

## Calculando clustering: Moran's I {.smaller}

- Uma estatística de clustering

3 - Criar 'ponderação' de vizinhos

```{r, echo=T}
neighbours_weights <- neighbours2 %>% nb2listw(style="W")
```

```{r}
neighbours_weights
```

## Calculando clustering: Moran's I {.smaller}

- Uma estatística de clustering

4 - Calcular a estatística Moran's I para a variável desejada

```{r, echo=T}
merged_contig %>% pull(Vote_Pct) %>% 
  moran(neighbours_weights,length(neighbours2),Szero(neighbours_weights)) %>% 
  with(I)
```

## Trabalhando com rasters

- Dados de raster estão disponíveis mas enormes (ex. https://ww2.ibge.gov.br/english/geociencias/default_prod.shtm)
- Usar `raster()` para abrir arquivos de tipo .tif
- Podemos acessar imagens de google maps com `gmap`

## Trabalhando com rasters {.smaller}

```{r, echo=T, warning=F, message=F, cache=T}
satellite <- gmap("Recife, Brazil",zoom=16,type="satellite")

satellite %>% as("SpatialPixelsDataFrame") %>% 
  as.data.frame() %>% 
  ggplot() + 
  geom_tile(aes(x=x,y=y,fill=get(names(satellite)))) +
  coord_equal()
```

## Trabalhando com rasters {.smaller}

```{r, echo=T, warning=F, message=F, cache=T}
terrain <- gmap("Recife, Brazil",zoom=16,type="terrain")

terrain %>% as("SpatialPixelsDataFrame") %>% 
  as.data.frame() %>% 
  ggplot() + 
  geom_tile(aes(x=x,y=y,fill=get(names(terrain)))) +
  coord_equal()
```

## Novas visualizações

- O design dos mapas destaca a parte da análise que queremos comunicar
- As vezes, áreas pequenas desaparecem
- Podemos exibir a posição relativa espacial sem exibir a área
    - Cartogram com áreas iguais

```{r, eval=F, echo=T}
devtools::install_github("jbaileyh/geogrid")
library(geogrid)
```

## Novas visualizações

```{r, cache=T, echo=T}
library(geogrid)
sf_hex_grid <- merged %>% calculate_grid(grid_type="hexagonal")
sf_hex_grid <- merged %>% assign_polygons(sf_hex_grid)

hex_map <- sf_hex_grid %>% st_as_sf() %>% ggplot() +
  geom_sf(aes(fill=Vote_Pct)) + 
  geom_text(aes(x=V1,y=V2,label=substr(NM_MUNICIP,1,2)),size=2,col="white") +
  theme_classic() + 
  coord_sf(datum=NA) + 
  xlab("") +
  ylab("")
```

## Novas visualizações

```{r, fig.width=10.5}
merged %>% ggplot() +
  geom_sf(aes(fill=Vote_Pct)) + 
  theme_classic() + 
  coord_sf(datum=NA)
```

## Novas visualizações

```{r, fig.width=10.5}
hex_map
```
